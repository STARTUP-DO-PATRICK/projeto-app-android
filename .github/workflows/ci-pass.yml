name: CI - Quick checks

on:
  pull_request:
    branches: [ 'master' ]
  push:
    branches: [ 'feat/compose-and-ci' ]

jobs:
  lint-html:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install htmlhint
        run: npm install -g htmlhint
      - name: Lint index.html
        run: |
          if [ -f index.html ]; then
            htmlhint index.html || true
          else
            echo "index.html not found, skipping htmlhint"
          fi

  build-optional:
    runs-on: ubuntu-latest
    needs: lint-html
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'
      - name: Attempt Android build if wrapper present
        run: |
          if [ -f ./gradlew ] && [ -f ./gradle/wrapper/gradle-wrapper.jar ]; then
            chmod +x ./gradlew
            ./gradlew assembleDebug --no-daemon
          else
            echo "Gradle wrapper or jar not present; skipping Android assemble (CI will still pass)."
          fi

  docker-build:
    runs-on: ubuntu-latest
    needs: lint-html
    steps:
      - uses: actions/checkout@v4
  android-build:
    runs-on: ubuntu-latest
    needs: lint-html
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-cache-${{ runner.os }}-$(hashFiles('**/*.gradle*','**/gradle-wrapper.properties'))
          restore-keys: |
            gradle-cache-${{ runner.os }}-

      - name: Install Android SDK
        uses: r0adkll/setup-android@v2
        with:
          api-levels: '33'
          build-tools: '33.0.2'
          components: 'platform-tools'

      - name: Make gradlew executable
        run: |
          if [ -f ./gradlew ]; then chmod +x ./gradlew; fi

      - name: Ensure wrapper and build
        run: |
          # If wrapper jar is missing but gradle is available, generate wrapper
          if [ -f ./gradlew ] && [ ! -f ./gradle/wrapper/gradle-wrapper.jar ]; then
            if command -v gradle >/dev/null 2>&1; then
              gradle wrapper --gradle-version 8.2.1
            fi
          fi

          # Build with wrapper if available
          if [ -f ./gradlew ]; then
            ./gradlew assembleDebug --no-daemon --stacktrace
          else
            echo "Gradle wrapper not found and could not be generated; skipping Android assemble.";
          fi

